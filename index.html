<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GreenMatch Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/imask"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #051c10;
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --text-main: #e0fff0;
            --text-muted: #8ab39e;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(0, 255, 136, 0.2);
            --shadow-glow: 0 0 20px rgba(0, 255, 136, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at top right, #0f3d26 0%, transparent 60%);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%; max-width: 450px; height: 100%; position: relative;
            background: var(--bg-deep); display: flex; flex-direction: column; overflow-y: auto;
        }

        /* --- UI ELEMENTS --- */
        .glass-card {
            background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border);
            border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .btn {
            width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;
        }
        .btn-primary { background: var(--primary); color: var(--bg-deep); box-shadow: var(--shadow-glow); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; background: #333; color: #666; box-shadow: none; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 0 15px rgba(37, 211, 102, 0.4); text-decoration: none; }
        .btn-map { background: #3b82f6; color: white; }

        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 15px;
            border-radius: 12px; color: white; font-family: inherit; margin-bottom: 15px; outline: none;
        }
        input:focus, textarea:focus { border-color: var(--primary); }

        .screen { display: none; flex-direction: column; padding: 20px; height: 100%; animation: fadeIn 0.4s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOGIN --- */
        .role-switch { display: flex; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 15px; margin-bottom: 20px; }
        .role-btn { flex: 1; padding: 12px; text-align: center; border-radius: 12px; cursor: pointer; color: var(--text-muted); transition: 0.3s; }
        .role-btn.active { background: var(--primary); color: var(--bg-deep); font-weight: 700; }

        .terms-box {
            height: 100px; overflow-y: auto; background: rgba(0,0,0,0.4); border: 1px solid var(--border);
            border-radius: 12px; padding: 10px; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; text-align: justify;
        }

        /* --- MODALS (Z-INDEX ALTO) --- */
        .provider-modal {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 95%; 
            background: #0a2919; border-top-left-radius: 30px; border-top-right-radius: 30px;
            z-index: 5000; padding: 30px; box-shadow: 0 -10px 40px rgba(0,0,0,0.9);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; border-top: 2px solid var(--primary);
            overflow-y: auto;
        }
        .provider-modal.show { transform: translateY(0); }

        .vehicle-icon-large {
            width: 100px; height: 100px; border-radius: 50%; background: var(--bg-deep);
            border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; color: var(--primary); margin-top: -80px; margin-bottom: 15px;
            box-shadow: 0 0 30px rgba(0,255,136,0.4); background: #051c10;
        }
        
        .modal-title { font-size: 1.5rem; font-weight: 800; color: #fff; margin-bottom: 5px; text-align: center; }
        .modal-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        .job-detail-row {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 10px;
        }
        .job-label { color: var(--text-muted); font-size: 0.8rem; }
        .job-value { color: #fff; font-weight: bold; font-size: 0.95rem; text-align: right; max-width: 60%; }
        .job-price { color: var(--primary); font-size: 1.4rem; font-weight: 900; }

        .close-modal {
            position: absolute; top: 15px; right: 20px; background: none; border: none; 
            color: #666; font-size: 1.5rem; cursor: pointer;
        }

        /* --- MAPA --- */
        #map { flex: 1; width: 100%; border-radius: 0; z-index: 1; }

        /* --- RADAR --- */
        .radar-screen {
            position: fixed; inset: 0; background: rgba(5, 28, 16, 0.95); z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .radar-circle {
            width: 200px; height: 200px; border-radius: 50%; border: 2px solid var(--primary);
            position: relative; box-shadow: 0 0 50px var(--primary);
        }
        .radar-scan {
            width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0,255,136,0.5) 360deg);
            animation: spin 2s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .radar-text { margin-top: 30px; font-size: 1.2rem; letter-spacing: 2px; color: var(--primary); text-align: center;}

    </style>
</head>
<body>

<div class="app-container">

    <div id="screen-auth" class="screen active">
        <div style="text-align:center; margin-bottom:20px;">
            <i class="fas fa-leaf" style="font-size:3rem; color:var(--primary);"></i>
            <h1 style="margin:0;">GreenMatch</h1>
        </div>

        <div class="glass-card">
            <div class="role-switch">
                <div class="role-btn active" onclick="setRole('client', this)">SOU CLIENTE</div>
                <div class="role-btn" onclick="setRole('provider', this)">SOU PRESTADOR</div>
            </div>

            <form id="loginForm">
                <label style="font-size:0.8rem; margin-left:5px; color:var(--text-muted);">Nome Completo</label>
                <input type="text" id="userName" required>

                <label style="font-size:0.8rem; margin-left:5px; color:var(--text-muted);">WhatsApp</label>
                <input type="tel" id="userPhone" placeholder="(00) 00000-0000" required>

                <div id="providerFields" style="display:none;">
                    <label style="font-size:0.8rem; margin-left:5px; color:var(--text-muted);">Seu Ve√≠culo</label>
                    <select id="userVehicle">
                        <option value="bike">üö≤ Bicicleta</option>
                        <option value="ebike">‚ö° Bike El√©trica</option>
                        <option value="scooter">üõ¥ Patinete</option>
                        <option value="foot">üö∂ A P√©</option>
                    </select>
                </div>

                <div class="terms-box">
                    <strong>TERMOS DE USO P2P</strong><br>
                    1. Este app conecta pessoas sem intermedi√°rios.<br>
                    2. O app n√£o se responsabiliza por pagamentos ou seguran√ßa.<br>
                    3. Uso exclusivo de ve√≠culos sustent√°veis.<br>
                    4. Dados locais apenas.
                </div>

                <div style="display:flex; gap:10px; align-items:center; margin-bottom:20px; font-size:0.8rem;">
                    <input type="checkbox" id="terms" style="width:20px; margin:0; accent-color:var(--primary);">
                    <span>Li e aceito os termos.</span>
                </div>

                <button type="submit" class="btn btn-primary" id="btnJoin" disabled>ENTRAR</button>
            </form>
        </div>
    </div>

    <div id="screen-request" class="screen">
        <h2 style="color:var(--primary); margin-bottom:20px;">Novo Pedido</h2>
        
        <div class="glass-card">
            <label style="color:var(--text-muted);">O que precisa ser feito?</label>
            <textarea id="serviceDesc" rows="2" placeholder="Ex: Buscar encomenda..."></textarea>

            <label style="color:var(--text-muted);">Transporte Desejado</label>
            <select id="reqTransport">
                <option value="any">Qualquer um (Mais R√°pido)</option>
                <option value="bike">üö≤ Bicicleta</option>
                <option value="ebike">‚ö° Bike El√©trica</option>
                <option value="foot">üö∂ A P√©</option>
            </select>

            <label style="color:var(--text-muted);">Onde pegar? (Origem)</label>
            <input type="text" id="reqPickup" placeholder="Ex: Farm√°cia Central">

            <label style="color:var(--text-muted);">Onde entregar? (Destino)</label>
            <input type="text" id="reqDelivery" placeholder="Ex: Rua das Flores, 123">

            <label style="color:var(--text-muted);">Valor Ofertado (R$)</label>
            <input type="number" id="reqValue" placeholder="0,00">
            
            <button class="btn btn-primary" onclick="startSearchLogic()">
                <i class="fas fa-search"></i> BUSCAR PRESTADOR
            </button>

            <button id="btnShowMap" class="btn" style="display:none; background:transparent; border:1px solid var(--primary); color:var(--primary); margin-top:10px;" onclick="goToMap()">
                <i class="fas fa-map-marked-alt"></i> VER PRESTADORES NO MAPA
            </button>
        </div>

        <button class="btn btn-danger" onclick="location.reload()">
            <i class="fas fa-sign-out-alt"></i> SAIR
        </button>
    </div>

    <div id="screen-map" class="screen" style="padding:0;">
        <div id="map" style="height:100%; width:100%;"></div>
        <button class="btn btn-primary" style="position:absolute; top:20px; left:20px; width:auto; padding:10px 20px; z-index:1000;" onclick="goBackToRequest()">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <div id="screen-provider" class="screen">
        <div class="glass-card">
            <h2>Painel do Parceiro</h2>
            <p>Status: <span style="color:var(--primary)">Dispon√≠vel üü¢</span></p>
            <p style="font-size:0.9rem; color:var(--text-muted);">Ve√≠culo: <span id="providerVehicleDisplay" style="color:#fff">...</span></p>
            
            <hr style="border-color:var(--border); margin:15px 0;">
            
            <div id="providerStatusArea" style="min-height:200px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <i class="fas fa-satellite-dish" style="font-size:3rem; color:var(--text-muted); opacity:0.5; animation: pulse 2s infinite;"></i>
                <p style="margin-top:15px; color:#aaa;">Buscando chamados pr√≥ximos...</p>
            </div>
        </div>
        
        <button class="btn btn-danger" onclick="location.reload()">SAIR</button>
    </div>

</div>

<div id="jobModal" class="provider-modal">
    <button class="close-modal" onclick="closeJobModal()">√ó</button>
    <div class="vehicle-icon-large"><i class="fas fa-user"></i></div>
    <div class="modal-title" style="margin-bottom:20px;">Solicita√ß√£o de Servi√ßo</div>
    
    <h3 style="color:var(--primary); margin-bottom:5px;" id="jobClientName">Nome do Cliente</h3>
    <div style="font-size:0.8rem; color:#aaa; margin-bottom:20px;">Contratante</div>

    <div class="job-detail-row">
        <span class="job-label">Servi√ßo</span>
        <span class="job-value" id="jobDesc">...</span>
    </div>
    <div class="job-detail-row">
        <span class="job-label">Origem</span>
        <span class="job-value" id="jobPickup">...</span>
    </div>
    <div class="job-detail-row">
        <span class="job-label">Destino</span>
        <span class="job-value" id="jobDelivery">...</span>
    </div>
    <div class="job-detail-row" style="background:rgba(0,255,136,0.1); border:1px solid var(--primary);">
        <span class="job-label" style="color:var(--primary);">VALOR OFERTADO</span>
        <span class="job-price" id="jobValue">R$ 0,00</span>
    </div>

    <a href="#" id="jobWhatsappLink" target="_blank" class="btn btn-whatsapp" style="margin-bottom:10px;">
        <i class="fab fa-whatsapp"></i> CHAMAR NO WHATSAPP
    </a>

    <button class="btn btn-map" onclick="openGoogleRoute()" style="margin-bottom:10px;">
        <i class="fas fa-map-marked-alt"></i> VER ROTA (GOOGLE MAPS)
    </button>

    <button class="btn" style="background:transparent; border:1px solid #ff4757; color:#ff4757;" onclick="closeJobModal()">
        IGNORAR
    </button>
</div>

<div id="providerDetailModal" class="provider-modal">
    <button class="close-modal" onclick="closeProviderDetailModal()">√ó</button>
    <div class="vehicle-icon-large"><i class="fas fa-leaf"></i></div>
    <div class="provider-name" id="detName">Prestador</div>
    <div class="provider-service" id="detVehicle">Ve√≠culo</div>
    <a href="#" id="detWhatsapp" target="_blank" class="btn btn-whatsapp">
        <i class="fab fa-whatsapp"></i> CHAMAR NO WHATSAPP
    </a>
</div>

<div class="radar-screen" id="radar">
    <div class="radar-circle"><div class="radar-scan"></div></div>
    <div class="radar-text" id="radarText">VARRENDO √ÅREA...</div>
</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = { apiKey: "API_KEY", authDomain: "APP.firebase", projectId: "ID" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.log("Offline Mode"); }

    // --- ESTADO ---
    let currentUser = null;
    let selectedRole = 'client';
    let searchAttempts = 0;
    let map = null;
    let currentJob = null; 

    // --- SETUP ---
    document.addEventListener('DOMContentLoaded', () => {
        IMask(document.getElementById('userPhone'), { mask: '(00) 00000-0000' });
        
        document.getElementById('terms').addEventListener('change', (e) => {
            const btn = document.getElementById('btnJoin');
            btn.disabled = !e.target.checked;
            btn.style.opacity = e.target.checked ? "1" : "0.5";
        });

        document.getElementById('loginForm').addEventListener('submit', handleManualLogin);
    });

    // --- LOGIN ---
    function setRole(role, btn) {
        selectedRole = role;
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('providerFields').style.display = role === 'provider' ? 'block' : 'none';
    }

    function handleManualLogin(e) {
        e.preventDefault();
        currentUser = {
            name: document.getElementById('userName').value,
            phone: document.getElementById('userPhone').value,
            role: selectedRole,
            vehicle: selectedRole === 'provider' ? document.getElementById('userVehicle').value : null
        };

        if(selectedRole === 'client') {
            switchScreen('screen-request');
        } else {
            document.getElementById('providerVehicleDisplay').innerText = getVehicleName(currentUser.vehicle);
            switchScreen('screen-provider');
            simulateProviderActivity();
        }
    }

    // --- BUSCA (CLIENTE) ---
    function startSearchLogic() {
        const desc = document.getElementById('serviceDesc').value;
        const pickup = document.getElementById('reqPickup').value;
        const delivery = document.getElementById('reqDelivery').value;
        const val = document.getElementById('reqValue').value;
        
        if(!desc || !pickup || !delivery || !val) return Swal.fire('Ops', 'Preencha todos os campos!', 'warning');

        // Salva job simulado com telefone
        localStorage.setItem('lastJob', JSON.stringify({
            client: currentUser.name,
            clientPhone: currentUser.phone,
            desc: desc,
            pickup: pickup,
            delivery: delivery,
            transport: document.getElementById('reqTransport').value,
            value: val
        }));

        const radar = document.getElementById('radar');
        const txt = document.getElementById('radarText');
        radar.style.display = 'flex';
        searchAttempts++;

        let steps = [{t:0, m:"500 METROS..."}, {t:2000, m:"1 KM..."}, {t:4000, m:"CIDADE INTEIRA..."}];
        steps.forEach(s => setTimeout(() => txt.innerText = s.m, s.t));

        setTimeout(() => {
            radar.style.display = 'none';
            Swal.fire({
                title: 'Sem resposta',
                text: 'Nenhum prestador aceitou ainda. Tente novamente ou veja o mapa.',
                icon: 'error',
                confirmButtonColor: '#00ff88',
                background: '#051c10', color: '#fff'
            });
            if(searchAttempts >= 2) document.getElementById('btnShowMap').style.display = 'flex';
        }, 6000);
    }

    // --- PRESTADOR (SIMULA√á√ÉO) ---
    function simulateProviderActivity() {
        setTimeout(() => {
            let job = JSON.parse(localStorage.getItem('lastJob'));
            if(!job) job = { 
                client: "Maria Silva", clientPhone: "(11) 99999-9999", 
                desc: "Entrega R√°pida", pickup: "Centro", delivery: "Bairro Alto", 
                transport: "bike", value: "20" 
            };
            
            const area = document.getElementById('providerStatusArea');
            area.innerHTML = `
                <div class="glass-card" style="border-color:var(--primary); cursor:pointer;" onclick='openJobModal(${JSON.stringify(job)})'>
                    <div style="display:flex; justify-content:space-between;">
                        <h3 style="color:var(--primary); margin:0;">üîî Novo Chamado!</h3>
                        <span style="font-weight:bold;">R$ ${job.value}</span>
                    </div>
                    <p style="margin:10px 0;">${job.desc}</p>
                    <small style="color:#aaa;">Toque para ver detalhes</small>
                </div>
            `;
        }, 5000);
    }

    function openJobModal(job) {
        currentJob = job;
        document.getElementById('jobClientName').innerText = job.client;
        document.getElementById('jobDesc').innerText = job.desc;
        document.getElementById('jobPickup').innerText = job.pickup;
        document.getElementById('jobDelivery').innerText = job.delivery;
        document.getElementById('jobValue').innerText = "R$ " + parseFloat(job.value).toFixed(2);
        
        // Configura link do WhatsApp Direto
        const phoneClean = job.clientPhone.replace(/\D/g, '');
        document.getElementById('jobWhatsappLink').href = `https://wa.me/55${phoneClean}?text=Ol√°, sou o prestador do GreenMatch! Vi seu pedido: ${job.desc}.`;

        document.getElementById('jobModal').classList.add('show');
    }

    function closeJobModal() {
        document.getElementById('jobModal').classList.remove('show');
    }

    function openGoogleRoute() {
        if(currentJob) {
            const origin = encodeURIComponent(currentJob.pickup);
            const dest = encodeURIComponent(currentJob.delivery);
            window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving`, '_blank');
        }
    }

    // --- MAPA ---
    function goToMap() {
        switchScreen('screen-map');
        setTimeout(initMap, 500);
    }

    function goBackToRequest() {
        switchScreen('screen-request');
        closeProviderDetailModal();
    }

    function initMap() {
        if(map) map.remove();
        map = L.map('map').setView([-23.5505, -46.6333], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                map.setView([lat, lng], 14);
                L.marker([lat, lng]).addTo(map).bindPopup("Voc√™").openPopup();
                generateProviders(lat, lng);
            });
        }
    }

    function generateProviders(lat, lng) {
        for(let i=0; i<5; i++) {
            const pLat = lat + (Math.random() - 0.5) * 0.03;
            const pLng = lng + (Math.random() - 0.5) * 0.03;
            const mapIcon = L.divIcon({
                className: 'custom-pin',
                html: `<div style="background:#00ff88; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid white; box-shadow:0 0 10px rgba(0,0,0,0.5); font-size:18px; color:#051c10;"><i class="fas fa-leaf"></i></div>`,
                iconSize: [35, 35]
            });
            const marker = L.marker([pLat, pLng], {icon: mapIcon}).addTo(map);
            const pData = { name: `Prestador Eco ${i+1}`, vehicle: "Bike El√©trica", phone: "5511999999999" };
            marker.on('click', () => openProviderDetailModal(pData));
        }
    }

    function openProviderDetailModal(data) {
        document.getElementById('detName').innerText = data.name;
        document.getElementById('detVehicle').innerText = data.vehicle;
        document.getElementById('detWhatsapp').href = `https://wa.me/${data.phone}`;
        document.getElementById('providerDetailModal').classList.add('show');
    }

    function closeProviderDetailModal() { document.getElementById('providerDetailModal').classList.remove('show'); }

    // --- UTIL ---
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function getVehicleName(v) {
        const map = { 'bike': 'Bicicleta', 'ebike': 'Bike El√©trica', 'scooter': 'Patinete', 'foot': 'A P√©', 'any': 'Qualquer' };
        return map[v] || v;
    }
    
    const style = document.createElement('style');
    style.innerHTML = `@keyframes pulse { 0% { transform: scale(1); opacity:1; } 50% { transform: scale(1.1); opacity:0.8; } 100% { transform: scale(1); opacity:1; } }`;
    document.head.appendChild(style);

</script>
</body>
</html>
