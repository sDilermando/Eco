<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoRota - Mobilidade P2P Sustent√°vel</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/imask"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            background: linear-gradient(45deg, #059669, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .logo p {
            color: #94a3b8;
            font-size: 1rem;
        }
        .tab-container {
            display: flex;
            background: #1e293b;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            background: transparent;
            border: none;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: #059669;
            color: white;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
            font-size: 0.95rem;
        }
        input, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #334155;
            border-radius: 12px;
            background: #1e293b;
            color: #f1f5f9;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        .terms-box {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            max-height: 120px;
            overflow-y: auto;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 24px;
        }
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary {
            background: linear-gradient(45deg, #059669, #10b981);
            color: white;
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(5, 150, 105, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-google {
            background: #fff;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .btn-google::before {
            content: 'üë§';
            font-size: 1.2rem;
        }
        #map {
            height: 400px;
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .floating-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        .btn-floating {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-sos {
            background: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }
        .btn-sos:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(239,68,68,0.5);
        }
        .btn-logout {
            background: #64748b;
            color: white;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }
        .radar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15,23,42,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }
        .radar-overlay.active {
            display: flex;
        }
        .radar-circle {
            width: 200px;
            height: 200px;
            border: 3px solid #059669;
            border-radius: 50%;
            position: relative;
            animation: radar 2s infinite linear;
        }
        @keyframes radar {
            0% { transform: scale(0.3) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(360deg); opacity: 0; }
        }
        .status-text {
            margin-top: 30px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #059669;
        }
        .order-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(5,150,105,0.3);
        }
        .accepted-state {
            background: linear-gradient(45deg, #059669, #10b981) !important;
            animation: celebrate 1s ease-in-out;
        }
        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .hidden {
            display: none !important;
        }
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            .floating-buttons {
                bottom: 10px;
                right: 10px;
            }
            .btn-floating {
                width: 55px;
                height: 55px;
            }
        }
        /* Evita quebra do layout com teclado */
        body.keyboard-open {
            padding-bottom: 200px;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Tela de Login/Cadastro -->
        <div id="loginScreen">
            <div class="logo">
                <h1>EcoRota</h1>
                <p>Mobilidade urbana sustent√°vel P2P</p>
            </div>
            
            <button class="btn btn-google" onclick="simulateGoogleLogin()">
                Entrar com Google
            </button>
            
            <div class="tab-container">
                <button class="tab active" onclick="switchTab('client')">Sou Cliente</button>
                <button class="tab" onclick="switchTab('provider')">Sou Prestador</button>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="userName" required>
                </div>
                
                <div class="form-group">
                    <label>WhatsApp (com DDD)</label>
                    <input type="tel" id="whatsapp" placeholder="(11) 99999-9999" required>
                </div>
                
                <div class="form-group hidden" id="vehicleGroup">
                    <label>Meio de Transporte</label>
                    <select id="vehicle" required>
                        <option value="">Selecione...</option>
                        <option value="bike">üö≤ Bike</option>
                        <option value="ebike">‚ö° E-Bike</option>
                        <option value="scooter">üõ¥ Patinete</option>
                        <option value="walk">üö∂ A P√©</option>
                    </select>
                </div>
                
                <div class="terms-box">
                    <strong>Termos de Uso P2P EcoRota</strong><br><br>
                    1. Uso exclusivo de ve√≠culos n√£o poluentes (bike, e-bike, patinete, a p√©).<br>
                    2. Priorizar seguran√ßa e respeito ao pr√≥ximo.<br>
                    3. Compartilhamento apenas via WhatsApp oficial.<br>
                    4. Bot√£o SOS sempre acess√≠vel (emerg√™ncia PM).<br>
                    5. Avalia√ß√£o obrigat√≥ria p√≥s-servi√ßo (+1 Estrela Eco).<br>
                    6. Proibido spam ou solicita√ß√µes inadequadas.<br><br>
                    <em>Aceitando, voc√™ concorda com nossa pol√≠tica de mobilidade sustent√°vel.</em>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="termsCheck">
                    <label for="termsCheck">Li e aceito os termos de uso</label>
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn" disabled>
                    Entrar na EcoRota
                </button>
            </form>
        </div>
        
        <!-- Tela Principal Cliente -->
        <div id="clientScreen" class="hidden">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Bem-vindo(a), <span id="clientName"></span>! üåø</h2>
                <button class="btn btn-primary" onclick="startRadar()">
                    üöÄ Buscar Prestador Pr√≥ximo
                </button>
            </div>
            <div id="map"></div>
            <div id="ordersList"></div>
        </div>
        
        <!-- Tela Principal Prestador -->
        <div id="providerScreen" class="hidden">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>üë®‚Äçüö¥ <span id="providerName"></span></h2>
                <p style="color: #94a3b8;">Aguardando pedidos pr√≥ximos...</p>
            </div>
            <div id="providerMap"></div>
            <div id="pendingOrders"></div>
        </div>
    </div>
    
    <!-- Overlay Radar -->
    <div class="radar-overlay" id="radarOverlay">
        <div class="radar-circle"></div>
        <div class="status-text" id="radarStatus">Iniciando varredura...</div>
    </div>
    
    <!-- Bot√µes Flutuantes -->
    <div class="floating-buttons hidden" id="floatingBtns">
        <a href="tel:190" class="btn-floating btn-sos" title="SOS - Emerg√™ncia">üö®</a>
        <button class="btn-floating btn-logout" onclick="logout()" title="Sair">üö™</button>
    </div>
    
    <script>
        // Config Firebase (substitua pelos seus dados)
        const firebaseConfig = {
            apiKey: "sua-api-key",
            authDomain: "seu-projeto.firebaseapp.com",
            databaseURL: "https://seu-projeto-default-rtdb.firebaseio.com",
            projectId: "seu-projeto",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "123456789",
            appId: "sua-app-id"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Estado da aplica√ß√£o
        let currentUser = null;
        let userType = null;
        let userLocation = null;
        let map = null;
        let userMarker = null;
        let radarTimeout = null;
        let searchRadius = 0.5; // km
        
        // M√°scara WhatsApp
        const whatsappMask = IMask(document.getElementById('whatsapp'), {
            mask: '(00) 00000-0000'
        });
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Detectar teclado mobile
            window.visualViewport?.addEventListener('resize', handleKeyboard);
            
            document.getElementById('termsCheck').addEventListener('change', function() {
                document.getElementById('loginBtn').disabled = !this.checked;
            });
            
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });
        
        function simulateGoogleLogin() {
            Swal.fire({
                icon: 'success',
                title: 'Google Login Simulado!',
                text: 'Usu√°rio autenticado com sucesso.',
                timer: 1500,
                showConfirmButton: false
            });
        }
        
        function switchTab(type) {
            userType = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const vehicleGroup = document.getElementById('vehicleGroup');
            if (type === 'provider') {
                vehicleGroup.classList.remove('hidden');
            } else {
                vehicleGroup.classList.add('hidden');
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const name = document.getElementById('userName').value;
            const whatsapp = document.getElementById('whatsapp').inputmask.unmaskedValue();
            
            if (!name || !whatsapp) {
                Swal.fire('Erro', 'Preencha todos os campos!', 'error');
                return;
            }
            
            if (userType === 'provider' && !document.getElementById('vehicle').value) {
                Swal.fire('Erro', 'Selecione seu ve√≠culo!', 'error');
                return;
            }
            
            currentUser = {
                id: `user_${Date.now()}`,
                name,
                whatsapp: `55${whatsapp}`,
                type: userType,
                vehicle: userType === 'provider' ? document.getElementById('vehicle').value : null,
                online: true,
                timestamp: Date.now()
            };
            
            // Salvar usu√°rio no Firebase
            await db.ref('users').child(currentUser.id).set(currentUser);
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById(`${userType}Screen`).classList.remove('hidden');
            document.getElementById('floatingBtns').classList.remove('hidden');
            
            if (userType === 'client') {
                document.getElementById('clientName').textContent = name;
                initClientMap();
            } else {
                document.getElementById('providerName').textContent = name;
                initProviderMap();
                listenForOrders();
            }
            
            getUserLocation();
        }
        
        function handleKeyboard() {
            const visible = window.visualViewport.height / window.innerHeight;
            document.body.classList.toggle('keyboard-open', visible < 0.8);
        }
        
        async function getUserLocation() {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (map && userMarker) {
                        userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                        map.setView([userLocation.lat, userLocation.lng], 15);
                    }
                },
                () => Swal.fire('Aviso', 'Habilite a localiza√ß√£o!', 'warning'),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }
        
        function initClientMap() {
            map = L.map('map').setView([-23.5505, -46.6333], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            
            userMarker = L.marker([0, 0], {
                icon: L.divIcon({
                    className: 'client-icon',
                    html: 'üë§',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                })
            }).addTo(map);
        }
        
        function initProviderMap() {
            map = L.map('providerMap').setView([-23.5505, -46.6333], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            userMarker = L.marker([0, 0], {
                icon: L.divIcon({
                    className: 'provider-icon',
                    html: 'üë®‚Äçüö¥',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                })
            }).addTo(map);
        }
        
        async function startRadar() {
            const overlay = document.getElementById('radarOverlay');
            const status = document.getElementById('radarStatus');
            overlay.classList.add('active');
            
            // Fase 1: 500m
            status.textContent = 'üîç Varrendo 500m...';
            await new Promise(r => setTimeout(r, 10000));
            
            // Fase 2: 2km
            status.textContent = 'üîç Varrendo 2km...';
            await new Promise(r => setTimeout(r, 10000));
            
            // Fase 3: Cidade toda
            status.textContent = 'üö® Prioridade M√°xima - Cidade Toda!';
            await new Promise(r => setTimeout(r, 10000));
            
            // Enviar pedido
            const order = {
                id: `order_${Date.now()}`,
                clientId: currentUser.id,
                clientName: currentUser.name,
                clientWhatsapp: currentUser.whatsapp,
                location: userLocation,
                type: 'transporte', // pode ser customizado
                description: 'Preciso de ajuda para me locomover!',
                status: 'pending',
                timestamp: Date.now(),
                expires: Date.now() + 30000 // 30s
            };
            
            await db.ref('orders').child(order.id).set(order);
            
            // Monitorar aceite
            radarTimeout = setTimeout(async () => {
                await db.ref('orders').child(order.id).remove();
                overlay.classList.remove('active');
                Swal.fire({
                    icon: 'info',
                    title: 'Alta demanda!',
                    text: 'Tente novamente em 5 minutos.',
                    timer: 3000
                });
            }, 30000);
            
            listenForOrderAcceptance(order.id);
        }
        
        function listenForOrderAcceptance(orderId) {
            db.ref('orders').child(orderId).on('value', (snapshot) => {
                const order = snapshot.val();
                if (order && order.status === 'accepted' && radarTimeout) {
                    clearTimeout(radarTimeout);
                    document.getElementById('radarOverlay').classList.remove('active');
                    
                    // Som de celebra√ß√£o
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAo');
                    audio.play();
                    
                    // Gamifica√ß√£o
                    document.getElementById('clientScreen').querySelector('.btn-primary')
                        .innerHTML = '‚ú® +1 Estrela Eco! ‚ú®';
                    
                    setTimeout(() => {
                        document.getElementById('clientScreen').querySelector('.btn-primary')
                            .innerHTML = 'üöÄ Buscar Prestador Pr√≥ximo';
                    }, 3000);
                    
                    // Abrir WhatsApp
                    const whatsappUrl = `https://wa.me/${order.providerWhatsapp}?text=Ol√°!%20Aceitei%20seu%20pedido%20EcoRota!%20üöÄ%20Estou%20a%20caminho!`;
                    window.open(whatsappUrl, '_blank');
                }
            });
        }
        
        function listenForOrders() {
            db.ref('orders').orderByChild('status').equalTo('pending').on('child_added', (snapshot) => {
                const order = snapshot.val();
                if (order.expires > Date.now()) {
                    displayPendingOrder(snapshot.key, order);
                }
            });
        }
        
        function displayPendingOrder(orderId, order) {
            const container = document.getElementById('pendingOrders');
            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `
                <h3>üë§ ${order.clientName}</h3>
                <p><strong>üìç Dist√¢ncia:</strong> ${calculateDistance(order.location, userLocation)?.toFixed(1)}km</p>
                <p><strong>üì± WhatsApp:</strong> ${formatWhatsapp(order.clientWhatsapp)}</p>
                <p>${order.description}</p>
                <button class="btn btn-primary" onclick="acceptOrder('${orderId}', '${order.clientWhatsapp}')">
                    ‚úÖ Aceitar Pedido
                </button>
            `;
            container.appendChild(card);
        }
        
        async function acceptOrder(orderId, clientWhatsapp) {
            const updates = {};
            updates[`orders/${orderId}/status`] = 'accepted';
            updates[`orders/${orderId}/providerWhatsapp`] = currentUser.whatsapp;
            updates[`orders/${orderId}/providerName`] = currentUser.name;
            updates[`orders/${orderId}/providerVehicle`] = currentUser.vehicle;
            
            await db.ref().update(updates);
            
            // Remover card visualmente
            document.querySelectorAll('.order-card').forEach(c => c.remove());
            
            Swal.fire({
                icon: 'success',
                title: 'Pedido Aceito!',
                text: 'Abra o WhatsApp para contato.',
                timer: 2000
            });
            
            // Abrir WhatsApp
            window.open(`https://wa.me/${clientWhatsapp}?text=Ol√°!%20Aceitei%20seu%20pedido%20EcoRota!%20${getVehicleEmoji(currentUser.vehicle)}%20Chegando%20logo!`, '_blank');
        }
        
        function calculateDistance(loc1, loc2) {
            if (!loc1 || !loc2) return null;
            const R = 6371; // km
            const dLat = (loc2.lat - loc1.lat) * Math.PI / 180;
            const dLng = (loc2.lng - loc1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(loc1.lat * Math.PI / 180) * Math.cos(loc2.lat * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function formatWhatsapp(num) {
            return num.replace('+55', '').replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
        
        function getVehicleEmoji(vehicle) {
            const emojis = {
                bike: 'üö≤',
                ebike: '‚ö°',
                scooter: 'üõ¥',
                walk: 'üö∂'
            };
            return emojis[vehicle] || '';
        }
        
        function logout() {
            if (currentUser) {
                db.ref('users').child(currentUser.id).update({ online: false });
            }
            location.reload();
        }
        
        // Cleanup no unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                db.ref('users').child(currentUser.id)?.update({ online: false });
            }
        });
    </script>
</body>
</html>
